<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>So Sushi Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            /* Slate 900 */
            color: #f1f5f9;
            /* Slate 100 */
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Bottom Sheet Animation */
        .bottom-sheet {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        /* Card Pulse Animation for New Orders */
        @keyframes subtle-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .new-order-pulse {
            animation: subtle-pulse 2s infinite;
        }
    </style>
</head>

<body class="pb-24">

    <!-- TOP APP BAR -->
    <header
        class="fixed top-0 left-0 right-0 h-16 bg-slate-900/90 backdrop-blur-md border-b border-slate-800 flex items-center justify-between px-4 z-40 shadow-sm">
        <div class="flex items-center gap-3">
            <div
                class="w-8 h-8 rounded-full bg-gradient-to-br from-red-600 to-orange-600 flex items-center justify-center shadow-lg shadow-red-500/20">
                <i class="fa-solid fa-fish-fins text-white text-xs"></i>
            </div>
            <h1 class="text-lg font-bold tracking-tight text-white">Admin Panel</h1>
        </div>
        <div class="flex items-center gap-3">
            <div id="status-indicator"
                class="px-2 py-0.5 rounded-full bg-gray-800 border border-gray-700 text-[10px] font-bold text-gray-400 flex items-center gap-1.5 transition-colors">
                <span class="w-1.5 h-1.5 rounded-full bg-gray-500"></span> OFFLINE
            </div>
            <button onclick="toggleSettings()"
                class="w-10 h-10 rounded-full hover:bg-slate-800 flex items-center justify-center text-slate-400 transition">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
        </div>
    </header>

    <!-- STATUS TABS / FILTERS -->
    <div
        class="fixed top-16 left-0 right-0 bg-slate-900 z-30 px-4 py-2 flex gap-2 overflow-x-auto no-scrollbar border-b border-slate-800">
        <button onclick="setFilter('all')" id="tab-all"
            class="px-4 py-1.5 rounded-full text-xs font-medium bg-white text-slate-900 whitespace-nowrap transition">
            Todos
        </button>
        <button onclick="setFilter('pending')" id="tab-pending"
            class="px-4 py-1.5 rounded-full text-xs font-medium bg-slate-800 text-slate-400 border border-slate-700 whitespace-nowrap transition">
            Pendientes <span id="badge-pending"
                class="ml-1 px-1.5 py-0.5 rounded-full bg-red-500 text-white text-[9px] hidden">0</span>
        </button>
        <button onclick="setFilter('cooking')" id="tab-cooking"
            class="px-4 py-1.5 rounded-full text-xs font-medium bg-slate-800 text-slate-400 border border-slate-700 whitespace-nowrap transition">
            Cocina
        </button>
        <button onclick="setFilter('ready')" id="tab-ready"
            class="px-4 py-1.5 rounded-full text-xs font-medium bg-slate-800 text-slate-400 border border-slate-700 whitespace-nowrap transition">
            Listos
        </button>
        <button onclick="setFilter('delivering')" id="tab-delivering"
            class="px-4 py-1.5 rounded-full text-xs font-medium bg-slate-800 text-slate-400 border border-slate-700 whitespace-nowrap transition">
            Reparto
        </button>
    </div>

    <!-- MAIN CONTENT (Orders List) -->
    <main id="orders-container" class="mt-32 px-4 flex flex-col gap-4 max-w-2xl mx-auto">
        <!-- JS Injected Cards -->
        <div class="flex flex-col items-center justify-center py-20 text-slate-600 gap-4">
            <i class="fa-solid fa-spinner fa-spin text-2xl"></i>
            <p class="text-sm">Cargando pedidos...</p>
        </div>
    </main>

    <!-- SETTINGS BOTTOM SHEET -->
    <div id="settings-overlay" class="fixed inset-0 bg-black/60 z-50 hidden transition-opacity opacity-0"
        onclick="toggleSettings()"></div>
    <div id="settings-sheet"
        class="fixed bottom-0 left-0 right-0 bg-slate-800 rounded-t-3xl z-50 bottom-sheet max-h-[85vh] overflow-y-auto border-t border-slate-700 shadow-2xl">
        <div class="w-12 h-1.5 bg-slate-600 rounded-full mx-auto mt-3 mb-6"></div>

        <div class="px-6 pb-8 space-y-8">
            <h2 class="text-xl font-bold text-white mb-4">Configuraci√≥n de Tienda</h2>

            <!-- Control 1: Estado General -->
            <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 flex items-center justify-between">
                <div>
                    <h3 class="font-bold text-white text-sm">Estado de Emergencia</h3>
                    <p class="text-xs text-slate-400 mt-1">Cierra la tienda inmediatamente</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="force-close-toggle" class="sr-only peer" onchange="saveStoreConfig()">
                    <div
                        class="w-11 h-6 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500">
                    </div>
                </label>
            </div>

            <!-- Control 2: Horarios -->
            <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600">
                <h3 class="font-bold text-white text-sm mb-3">Horario Autom√°tico (24h)</h3>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label class="text-[10px] uppercase text-slate-400 font-bold mb-1 block">Apertura</label>
                        <input type="time" id="open-hour"
                            class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-center text-white font-mono appearance-none"
                            value="16:00">
                    </div>
                    <span class="text-slate-500">-</span>
                    <div class="flex-1">
                        <label class="text-[10px] uppercase text-slate-400 font-bold mb-1 block">Cierre</label>
                        <input type="time" id="close-hour"
                            class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-center text-white font-mono appearance-none"
                            value="23:00">
                    </div>
                </div>
                <button onclick="saveStoreConfig()"
                    class="w-full mt-4 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-500/20 active:scale-95 transition">
                    Guardar Horario
                </button>
            </div>

            <!-- Control 3: Alta Demanda -->
            <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 flex items-center justify-between">
                <div>
                    <h3 class="font-bold text-white text-sm">Modo Alta Demanda</h3>
                    <p class="text-xs text-slate-400 mt-1">Muestra banner de "Pedidos Lentos"</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="high-demand-toggle" class="sr-only peer" onchange="toggleHighDemand()">
                    <div
                        class="w-11 h-6 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500">
                    </div>
                </label>
            </div>

            <div class="text-center text-[10px] text-slate-600 pt-4">
                So Sushi Admin v2.1 &bull; Android Style Redesign
            </div>
        </div>
    </div>

    <!-- Audio Settings -->
    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // --- LOGIC ---
        let orders = [];
        let lastOrderCount = 0;
        let currentFilter = 'all';

        // Filters UI
        function setFilter(filter) {
            currentFilter = filter;
            // Update Tab UI
            const tabs = ['all', 'pending', 'cooking', 'ready', 'delivering'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === filter) {
                    btn.className = "px-4 py-1.5 rounded-full text-xs font-medium bg-white text-slate-900 whitespace-nowrap transition shadow-sm";
                } else {
                    btn.className = "px-4 py-1.5 rounded-full text-xs font-medium bg-slate-800 text-slate-400 border border-slate-700 whitespace-nowrap transition hover:bg-slate-700";
                }
            });
            renderOrders();
        }

        // --- API CALLS ---
        async function fetchOrders() {
            try {
                const res = await fetch('https://menuia.onrender.com/api/orders?active=true');
                const newOrders = await res.json();

                // Sound & Haptic Notification
                if (newOrders.length > lastOrderCount && lastOrderCount !== 0) {
                    playNotification();
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                }

                lastOrderCount = newOrders.length;
                orders = newOrders;
                renderOrders();
                updateIndicators();
            } catch (err) { console.error("Error/Offline", err); }
        }

        async function updateStatus(id, newStatus) {
            // Android-like quick action, no confirm alert for speed, just direct action (maybe undo later)
            // But let's keep confirm for destructive actions like cancel
            if (newStatus === 'cancelled' && !confirm("¬øSeguro que deseas cancelar?")) return;

            try {
                // Optimistic UI update
                const orderIdx = orders.findIndex(o => o._id === id);
                if (orderIdx > -1) {
                    orders[orderIdx].status = newStatus;
                    renderOrders();
                }

                await fetch(`https://menuia.onrender.com/api/orders/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                fetchOrders(); // Sync real state
            } catch (err) { alert("Error de red"); fetchOrders(); }
        }

        function renderOrders() {
            const container = document.getElementById('orders-container');

            let filtered = orders;
            if (currentFilter !== 'all') {
                filtered = orders.filter(o => o.status === currentFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-slate-600 gap-4 opacity-50">
                    <i class="fa-regular fa-folder-open text-4xl"></i>
                    <p class="text-sm">No hay pedidos en esta secci√≥n</p>
                </div>`;
                return;
            }

            container.innerHTML = filtered.map(order => {
                const date = new Date(order.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const total = order.total ? `$${order.total.toFixed(0)}` : 'N/A';

                // Status Logic
                let statusColor = "bg-slate-700 text-slate-300";
                let actionBtn = "";

                if (order.status === 'pending') {
                    statusColor = "bg-yellow-500/20 text-yellow-500 border border-yellow-500/30";
                    actionBtn = `<button onclick="updateStatus('${order._id}', 'cooking')" class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-lg text-sm shadow-lg shadow-yellow-900/50 active:scale-95 transition">üî• Cocinar</button>`;
                } else if (order.status === 'cooking') {
                    statusColor = "bg-orange-500/20 text-orange-500 border border-orange-500/30";
                    actionBtn = `<button onclick="updateStatus('${order._id}', 'ready')" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg text-sm shadow-lg shadow-green-900/50 active:scale-95 transition">‚úÖ Listo</button>`;
                } else if (order.status === 'ready') {
                    statusColor = "bg-green-500/20 text-green-500 border border-green-500/30";
                    actionBtn = `<button onclick="updateStatus('${order._id}', 'delivering')" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg text-sm shadow-lg shadow-blue-900/50 active:scale-95 transition">üõµ Enviar</button>`;
                } else if (order.status === 'delivering') {
                    statusColor = "bg-blue-500/20 text-blue-500 border border-blue-500/30";
                    actionBtn = `<button onclick="updateStatus('${order._id}', 'completed')" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg text-sm shadow-lg shadow-black/30 active:scale-95 transition">üèÅ Completar</button>`;
                }

                // Add "New Order" visual cue
                const isNew = (Date.now() - new Date(order.createdAt).getTime()) < 60000; // < 1 min old
                const pulseClass = isNew && order.status === 'pending' ? 'new-order-pulse border-red-500/50' : 'border-slate-800';

                // Coupon HTML
                let couponHtml = '';
                if (order.coupon) {
                    couponHtml = `
                        <div class="mb-3 bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-500/40 rounded-lg p-3 flex items-center gap-3 animate-pulse">
                            <span class="text-2xl">üéÅ</span>
                            <div>
                                <p class="font-bold text-purple-400 text-xs uppercase tracking-wider">Cup√≥n Aplicado</p>
                                <p class="text-sm text-white font-bold">${order.coupon.description || order.coupon.code}</p>
                            </div>
                        </div>
                    `;
                }

                return `
                <div class="bg-slate-800 rounded-2xl p-4 border ${pulseClass} shadow-md relative overflow-hidden transition-all">
                    <!-- Header Card -->
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                             <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center font-bold text-slate-300 border border-slate-600">
                                ${order.customer.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h3 class="font-bold text-white leading-tight">${order.customer.name}</h3>
                                <p class="text-[10px] text-slate-400 font-mono mt-0.5">${order.customer.phone}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${statusColor}">
                                ${translateStatus(order.status)}
                            </span>
                            <span class="text-[10px] text-slate-500 font-mono">${date}</span>
                        </div>
                    </div>

                    <!-- Address -->
                    ${couponHtml}
                    <div class="bg-slate-900/50 rounded-lg p-3 mb-3 border border-slate-700/50 flex items-start gap-2">
                        <i class="fa-solid fa-location-dot text-red-500 mt-0.5 text-xs"></i>
                        <p class="text-xs text-slate-300 leading-relaxed">${order.customer.address}</p>
                    </div>

                    <!-- Items List -->
                    <div class="space-y-2 mb-4">
                        ${order.items.map(item => `
                            <div class="flex justify-between items-start text-sm text-slate-300 pb-1 border-b border-white/5 last:border-0">
                                <span class="leading-snug"><span class="font-bold text-white">${item.quantity}x</span> ${item.name} <span class="text-xs text-slate-500 ml-1">(${item.protein})</span></span>
                            </div>
                            ${item.note ? `<p class="text-xs text-yellow-500 italic ml-4 mb-1"><i class="fa-solid fa-comment-dots mr-1"></i>${item.note}</p>` : ''}
                        `).join('')}
                    </div>

                    <!-- Footer / Actions -->
                    <div class="flex items-center gap-3 mt-2">
                        ${actionBtn}
                        ${order.status === 'pending' ?
                        `<button onclick="updateStatus('${order._id}', 'cancelled')" class="w-12 h-12 flex items-center justify-center rounded-lg bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500/20 active:scale-95 transition"><i class="fa-solid fa-trash"></i></button>`
                        : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- HELPERS ---
        function updateIndicators() {
            // Badges
            const pendingCount = orders.filter(o => o.status === 'pending').length;
            const badge = document.getElementById('badge-pending');
            if (pendingCount > 0) {
                badge.innerText = pendingCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function translateStatus(status) {
            const map = { 'pending': 'Pendiente', 'cooking': 'Cocinando', 'ready': 'Listo', 'delivering': 'Ruta', 'completed': 'Entregado', 'cancelled': 'Cancelado' };
            return map[status] || status;
        }

        function playNotification() {
            const audio = document.getElementById('notification-sound');
            audio.play().catch(e => console.log("Audio requires interaction"));
        }

        // --- SETTINGS UI LOGIC ---
        function toggleSettings() {
            const overlay = document.getElementById('settings-overlay');
            const sheet = document.getElementById('settings-sheet');

            if (overlay.classList.contains('hidden')) {
                // Open
                overlay.classList.remove('hidden');
                // Trigger reflow
                void overlay.offsetWidth;
                overlay.classList.remove('opacity-0');
                sheet.classList.add('active');
            } else {
                // Close
                overlay.classList.add('opacity-0');
                sheet.classList.remove('active');
                setTimeout(() => { overlay.classList.add('hidden'); }, 300);
            }
        }

        async function fetchConfig() {
            try {
                // High Demand
                const res1 = await fetch(`${API_URL}/api/config/high-demand`);
                const data1 = await res1.json();
                document.getElementById('high-demand-toggle').checked = data1.isHighDemand;

                // Hours
                // Hours
                const res2 = await fetch(`${API_URL}/api/config/hours`);
                const data2 = await res2.json();
                if (data2) {
                    // Use raw Time String ("16:00") directly with fallback
                    document.getElementById('open-hour').value = data2.open || "16:00";
                    document.getElementById('close-hour').value = data2.close || "23:00";
                    document.getElementById('force-close-toggle').checked = data2.force_close;
                    updateHeaderStatus(data2.force_close);
                }
            } catch (e) { console.error(e); }
        }

        async function saveStoreConfig() {
            // Send raw Time String ("16:30") directly
            const open = document.getElementById('open-hour').value;
            const close = document.getElementById('close-hour').value;
            const force_close = document.getElementById('force-close-toggle').checked;

            try {
                await fetch(`${API_URL}/api/config/hours`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ open, close, force_close })
                });
                updateHeaderStatus(force_close);
                // Maybe show a small toast?
            } catch (e) { alert("Error guardando"); }
        }

        async function toggleHighDemand() {
            const enabled = document.getElementById('high-demand-toggle').checked;
            try {
                await fetch(`${API_URL}/api/config/high-demand`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
            } catch (e) { alert("Error"); }
        }

        function updateHeaderStatus(isForceClosed) {
            const indicator = document.getElementById('status-indicator');
            if (isForceClosed) {
                indicator.className = "px-2 py-0.5 rounded-full bg-red-900/50 border border-red-700 text-[10px] font-bold text-red-400 flex items-center gap-1.5 transition-colors";
                indicator.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> CERRADO`;
            } else {
                indicator.className = "px-2 py-0.5 rounded-full bg-emerald-900/50 border border-emerald-700 text-[10px] font-bold text-emerald-400 flex items-center gap-1.5 transition-colors";
                indicator.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> ONLINE`;
            }
        }

        // --- REAL-TIME UPDATES ---
        // const API_URL = 'http://localhost:3000';
        const API_URL = 'https://menuia.onrender.com';
        const socket = io(API_URL);

        socket.on('connect', () => {
            console.log("üü¢ Connected to Socket.IO");
        });

        socket.on('new-order', (order) => {
            console.log("üîî New Order:", order);
            playNotification();
            showToast("¬°Nuevo Pedido Recibido!");
            fetchOrders(); // Refresh list immediately
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        });

        socket.on('order-status-changed', (order) => {
            console.log("üîÑ Status Update:", order);
            fetchOrders();
        });

        socket.on('config-updated', (config) => {
            console.log("‚öôÔ∏è Config Sync:", config);
            if (config.force_close !== undefined) updateHeaderStatus(config.force_close);

            document.getElementById('open-hour').value = config.open || "16:00";
            document.getElementById('close-hour').value = config.close || "23:00";
            document.getElementById('force-close-toggle').checked = config.force_close;
        });

        function showToast(msg) {
            // Simple toast implementation if not exists, or reuse existing
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-full shadow-lg z-50 animate-bounce';
            toast.innerHTML = `<i class="fa-solid fa-bell"></i> ${msg}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Init
        fetchConfig();
        fetchOrders();
        setInterval(fetchOrders, 10000);

    </script>
</body>

</html>
