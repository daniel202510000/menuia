<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargando...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; /* Slate 50 */
            color: #1e293b; /* Slate 800 */
            background-image: radial-gradient(circle at 50% 0%, #eff6ff 0%, #f8fafc 70%); /* Light Gradient */
            background-attachment: fixed; 
        }
        
        /* Premium Neural Animations */
        @keyframes subtle-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .neural-bg { animation: subtle-pulse 4s infinite ease-in-out; }
        
        html { scroll-behavior: smooth; }
        
        /* Cards & Interactions */
        .sushi-card { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8); /* Slate 200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .sushi-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: rgba(59, 130, 246, 0.5);
        }

        /* Modals */
        .modal { transition: opacity 0.3s ease, visibility 0.3s; opacity: 0; visibility: hidden; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95) translateY(10px); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal.active .modal-content { transform: scale(1) translateY(0); }

        /* Badges */
        .badge-ai-match {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; font-weight: 700; font-size: 0.65rem;
            padding: 2px 8px; border-radius: 99px;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
            display: flex; align-items: center; gap: 4px;
        }

        /* AI Chat Interface - Light Theme */
        .chat-container-premium {
            background-image: linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)), url('https://www.transparenttextures.com/patterns/graphy.png');
        }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 12px; font-size: 0.9rem; line-height: 1.5; animation: messageSlide 0.3s ease-out; position: relative; }
        .chat-bubble.bot { 
            background: #f1f5f9; /* Slate 100 */
            color: #334155; /* Slate 700 */
            border-bottom-left-radius: 4px; 
            border: 1px solid #e2e8f0;
        }
        .chat-bubble.bot::before {
            content: ''; position: absolute; left: -6px; bottom: 0;
            width: 0; height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #e2e8f0;
        }
        .chat-bubble.user { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            border-bottom-right-radius: 4px; 
            align-self: flex-end; 
            text-align: right;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }
        
        .chat-option-btn { 
            background: white; 
            border: 1px solid #e2e8f0; 
            color: #64748b; 
            padding: 10px 16px; 
            border-radius: 12px; 
            font-size: 0.85rem; 
            cursor: pointer; 
            transition: all 0.2s; 
            font-weight: 500;
            text-align: center;
            flex: 1 1 auto;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .chat-option-btn:hover { 
            background: #eff6ff; 
            border-color: #3b82f6; 
            color: #2563eb; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Animations */
        @keyframes messageSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes progress-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }
        .animate-stripes { background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent); background-size: 1rem 1rem; animation: progress-stripes 1s linear infinite; }
        
        /* Tracker Styles */
        .step-item { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; flex: 1; }
        .step-icon { width: 32px; height: 32px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; z-index: 10; border: 2px solid #d1d5db; transition: all 0.3s; }
        .step-item.active .step-icon { background: #2563eb; border-color: #60a5fa; box-shadow: 0 0 10px rgba(37, 99, 235, 0.3); transform: scale(1.1); }
        .step-item.active .step-icon i { color: white; }
        .step-item.completed .step-icon { background: #059669; border-color: #34d399; }
        .step-item.completed .step-icon i { color: white; }
        .step-line { position: absolute; top: 16px; left: -50%; width: 100%; height: 2px; background: #e5e7eb; z-index: 1; }
        .step-item:first-child .step-line { display: none; }
        .step-item.active .step-line, .step-item.completed .step-line { background: #059669; }
        .step-label { font-size: 0.55rem; color: #94a3b8; margin-top: 4px; text-align: center; font-weight: bold; text-transform: uppercase; transition: color 0.3s; }
        .step-item.active .step-label { color: #2563eb; text-shadow: none; }
        .step-item.completed .step-label { color: #059669; }
        .pulse-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid #2563eb; opacity: 0; animation: ripple 1.5s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2); opacity: 0; } }

        /* Loader */
        #app-loader { background-color: #f8fafc; }
    </style>
</head>
<body class="text-slate-800 ai-active" onclick="resetIdleTimer()" onscroll="resetIdleTimer()">

    <div id="app-loader" class="fixed inset-0 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <i class="fa-solid fa-robot text-6xl text-blue-600 animate-bounce mb-4"></i>
        <p class="text-xl font-bold animate-pulse text-slate-800" id="loader-text">Cargando...</p>
    </div>

    <!-- Header / Navbar -->
    <nav class="bg-white/90 backdrop-blur-md shadow-sm fixed w-full z-50 top-0 border-b border-gray-200 transition-all duration-300">
        
        <!-- DISE√ëO PREMIUM BARRA RASTREO (Light) -->
        <div id="tracker-header" class="hidden bg-white border-b border-gray-200 w-full animate-fade-in shadow-sm relative overflow-hidden">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-5"></div>
            <div class="max-w-7xl mx-auto px-4 py-3 relative z-10">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-blue-50 border border-blue-200 flex items-center justify-center relative shadow-sm">
                            <i id="header-status-icon" class="fa-solid fa-fire-burner text-blue-600 text-lg animate-pulse"></i>
                            <div class="absolute inset-0 rounded-full border border-blue-400 opacity-20 animate-ping"></div>
                        </div>
                        <div class="flex flex-col">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-blue-600 uppercase tracking-wider" id="header-order-id">ORDEN #...</span>
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-700 border border-blue-200 hidden sm:inline-block" id="header-eta">Actualizado</span>
                            </div>
                            <span class="text-sm font-bold text-slate-800 leading-tight truncate max-w-[200px]" id="header-tracker-status">Cargando estado...</span>
                        </div>
                    </div>
                    <div class="flex-1 max-w-[200px] sm:max-w-xs flex flex-col justify-center gap-1.5">
                        <div class="flex justify-between text-[10px] text-gray-500 font-medium px-1">
                            <span>Progreso</span>
                            <span id="header-progress-text">0%</span>
                        </div>
                        <div class="h-2.5 bg-gray-100 rounded-full overflow-hidden border border-gray-200">
                            <div id="header-progress-bar" class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 animate-stripes transition-all duration-1000 ease-out shadow-sm" style="width: 5%"></div>
                        </div>
                    </div>
                    <button onclick="toggleUserModal()" class="hidden sm:flex bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-full transition border border-gray-200 shadow-sm">
                        <i class="fa-solid fa-chevron-down"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="status-banner" class="text-white text-center py-1 text-xs font-bold tracking-wider uppercase transition-colors duration-300"></div>
        
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14">
                <div class="flex items-center gap-2">
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 w-9 h-9 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                        <i class="fa-solid fa-utensils text-white text-sm"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-slate-900" id="brand-name">TIENDA</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleUserModal()" class="text-gray-500 hover:text-slate-900 transition flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-200 hover:border-blue-400 hover:bg-white shadow-sm">
                        <i class="fa-solid fa-user-circle text-lg"></i>
                        <span id="nav-user-name" class="text-xs font-bold hidden sm:inline">Ingresar</span>
                        <span id="nav-order-indicator" class="hidden w-2 h-2 bg-green-500 rounded-full animate-pulse absolute top-0 right-0"></span>
                    </button>

                    <button onclick="toggleAI()" class="group relative bg-white hover:bg-blue-50 text-slate-700 border border-blue-200 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 transition overflow-hidden shadow-sm">
                        <div class="absolute inset-0 bg-blue-500/5 group-hover:bg-blue-500/10 transition"></div>
                        <i class="fa-solid fa-sparkles animate-pulse text-purple-500"></i> <span class="hidden sm:inline bg-gradient-to-r from-blue-600 to-purple-600 text-transparent bg-clip-text font-extrabold">IA Chef</span>
                    </button>
                    
                    <div class="relative cursor-pointer hover:scale-110 transition duration-300" onclick="toggleCart()">
                        <div class="flex items-center gap-2">
                            <div class="relative">
                                <i class="fa-solid fa-cart-shopping text-2xl text-gray-600 hover:text-blue-600 transition"></i>
                                <span id="cart-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] font-bold rounded-full h-4 w-4 flex items-center justify-center border border-white shadow-sm">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="relative bg-slate-50 h-80 mt-20 flex items-center justify-center overflow-hidden">
        <img id="hero-img" src="" class="absolute w-full h-full object-cover transform hover:scale-105 transition duration-[30s] scale-100">
        <!-- Light Gradient Overlay -->
        <div class="absolute inset-0 bg-gradient-to-t from-slate-50 via-slate-50/60 to-transparent"></div>
        <div class="relative z-10 text-center px-4 max-w-3xl pt-10">
            <!-- Contextual Badge -->
            <div id="context-badge" class="inline-flex items-center gap-2 mb-3 px-4 py-1.5 rounded-full bg-white/80 border border-slate-200 backdrop-blur-md shadow-md transform hover:scale-105 transition cursor-default">
                <i class="fa-regular fa-clock text-yellow-500 animate-spin-slow"></i>
                <span class="text-slate-700 text-xs font-bold tracking-wide uppercase" id="context-text">Cargando contexto...</span>
            </div>
            
            <h1 class="text-5xl md:text-7xl font-bold text-slate-900 mb-2 drop-shadow-sm tracking-tight leading-none" id="hero-title">BIENVENIDO</h1>
            <p class="text-slate-600 text-lg font-light mb-6">Tu experiencia gastron√≥mica, re-imaginada.</p>
            <div id="hero-badge" class="hidden inline-block bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg cursor-default"></div>
        </div>
    </div>

    <!-- Filtros Inteligentes -->
    <div class="sticky top-20 z-40 bg-white/80 backdrop-blur-xl border-b border-gray-200 py-3 mb-6 transition-all shadow-sm" id="ai-filters-bar">
        <div class="max-w-7xl mx-auto px-4 overflow-x-auto">
            <div class="flex items-center gap-3 min-w-max">
                <span class="text-slate-500 text-xs font-bold uppercase tracking-wider flex items-center gap-1"><i class="fa-solid fa-layer-group"></i> Men√∫:</span>
                <button onclick="applyAIFilter('all')" class="ai-filter-btn active px-4 py-1.5 rounded-full text-xs font-medium border border-gray-200 bg-white text-slate-600 hover:text-slate-900 hover:bg-gray-50 transition">Todo</button>
                <button onclick="applyAIFilter('top')" class="ai-filter-btn px-4 py-1.5 rounded-full text-xs font-medium border border-gray-200 bg-white text-slate-600 hover:text-slate-900 hover:border-purple-400 transition"><i class="fa-solid fa-crown text-purple-500 mr-1"></i> Populares</button>
                <button onclick="applyAIFilter('promo')" class="ai-filter-btn px-4 py-1.5 rounded-full text-xs font-medium border border-gray-200 bg-white text-slate-600 hover:text-slate-900 hover:border-yellow-400 transition"><i class="fa-solid fa-tag text-yellow-500 mr-1"></i> Ofertas</button>
            </div>
        </div>
    </div>

    <!-- Menu Section -->
    <div class="max-w-7xl mx-auto px-4 pb-24 min-h-[60vh]">
        <div id="menu-sections"></div>
        <div id="no-results" class="hidden text-center py-20">
            <i class="fa-solid fa-robot text-6xl text-slate-300 mb-4 animate-bounce"></i>
            <p class="text-slate-500 text-xl">Sin resultados para este filtro.</p>
            <button onclick="applyAIFilter('all')" class="mt-4 text-blue-600 hover:text-blue-500 underline">Ver todo el men√∫</button>
        </div>
    </div>

    <!-- MODAL DE OPCIONES / TOPPINGS (Light) -->
    <div id="options-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm px-4">
        <div class="bg-white w-full max-w-sm rounded-2xl border border-gray-100 shadow-2xl overflow-hidden transform transition-all">
            <div class="p-5 bg-slate-50 border-b border-gray-200 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Personaliza tu orden</h3>
                <button onclick="toggleOptionsModal(false)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-5 max-h-[60vh] overflow-y-auto">
                <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3" id="options-instruction">Complementos disponibles:</p>
                <div id="options-list" class="space-y-3"></div>
            </div>
            <div class="p-5 bg-slate-50 border-t border-gray-200">
                <button id="modal-confirm-btn" onclick="confirmOptions()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-blue-500/20">Confirmar y Agregar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE LOGIN USUARIO (Light) -->
    <div id="user-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm px-4">
        <div class="modal-content bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-gray-50 border-b border-gray-200 flex">
                <button onclick="switchAuthTab('login')" id="tab-login" class="flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition">Iniciar Sesi√≥n</button>
                <button onclick="switchAuthTab('register')" id="tab-register" class="flex-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 transition">Crear Cuenta</button>
            </div>
            
            <div class="p-6 relative">
                <button onclick="toggleUserModal()" class="absolute top-2 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-lg"></i></button>

                <!-- LOGIN -->
                <form id="form-login" onsubmit="event.preventDefault(); handleUserLogin();" class="space-y-4">
                    <div class="text-center mb-4">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2 text-xl"><i class="fa-solid fa-user"></i></div>
                        <h3 class="text-lg font-bold text-gray-800">¬°Bienvenido de nuevo!</h3>
                        <p class="text-xs text-gray-500">Accede para rastrear tus pedidos.</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Celular</label>
                        <input type="tel" id="login-phone" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition" placeholder="Tu n√∫mero" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Contrase√±a</label>
                        <input type="password" id="login-pass" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">Entrar</button>
                </form>

                <!-- REGISTER -->
                <form id="form-register" onsubmit="event.preventDefault(); handleUserRegister();" class="space-y-4 hidden">
                    <div class="text-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Crear Cuenta</h3>
                        <p class="text-xs text-gray-500">Es r√°pido y f√°cil.</p>
                    </div>
                    <input type="text" id="reg-name" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl text-slate-800 outline-none text-sm" placeholder="Nombre Completo" required>
                    <input type="tel" id="reg-phone" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl text-slate-800 outline-none text-sm" placeholder="Celular" required>
                    <textarea id="reg-address" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl text-slate-800 outline-none text-sm" rows="2" placeholder="Direcci√≥n de entrega" required></textarea>
                    <input type="password" id="reg-pass" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl text-slate-800 outline-none text-sm" placeholder="Contrase√±a" required>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition">Registrarme</button>
                </form>

                <!-- PANEL USUARIO -->
                <div id="user-info-panel" class="hidden text-center py-4">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-full flex items-center justify-center mx-auto mb-3 text-3xl font-bold shadow-lg" id="user-initial">U</div>
                    <h3 class="font-bold text-xl text-gray-800" id="display-user-name">Usuario</h3>
                    <p class="text-sm text-gray-500 mb-6" id="display-user-phone">...</p>
                    
                    <!-- RASTREO INTEGRADO (Solo visible si hay orden y login) -->
                    <div id="active-order-card" class="hidden mb-6 bg-white p-5 rounded-2xl border border-blue-100 shadow-xl text-left relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-purple-500"></div>
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="font-bold text-gray-800 text-sm uppercase flex items-center gap-2"><i class="fa-solid fa-location-dot text-blue-500 animate-bounce"></i> En curso</h4>
                            <span class="text-[10px] font-mono bg-gray-100 px-2 py-1 rounded text-gray-500" id="tracker-order-id">#...</span>
                        </div>
                        
                        <div class="flex justify-between w-full relative mb-6">
                            <div class="step-item active" id="step-pending"><div class="step-icon"><i class="fa-solid fa-check text-[10px]"></i></div><div class="step-label">Orden</div><div class="step-line"></div></div>
                            <div class="step-item" id="step-preparing"><div class="step-icon"><i class="fa-solid fa-fire text-[10px]"></i></div><div class="step-label">Cocina</div><div class="step-line"></div></div>
                            <div class="step-item" id="step-ready"><div class="step-icon"><i class="fa-solid fa-box text-[10px]"></i></div><div class="step-label">Listo</div><div class="step-line"></div></div>
                            <div class="step-item" id="step-delivering"><div class="step-icon"><i class="fa-solid fa-motorcycle text-[10px]"></i></div><div class="step-label">Camino</div><div class="step-line"></div></div>
                        </div>
                        
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center">
                            <p class="font-bold text-blue-700 text-sm mb-1" id="tracker-status-text">Procesando...</p>
                            <p class="text-[11px] text-blue-500" id="tracker-status-desc">...</p>
                        </div>
                    </div>

                    <button onclick="logoutUser()" class="text-red-500 font-bold text-xs hover:bg-red-50 px-6 py-2 rounded-full transition">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Carrito Modal (Light) -->
    <div id="cart-modal" class="modal fixed inset-0 z-50 flex justify-end bg-black/50 backdrop-blur-sm">
        <div class="modal-content bg-white w-full max-w-md h-full shadow-2xl flex flex-col border-l border-gray-200">
            <div class="bg-white p-5 text-slate-800 flex justify-between items-center shadow-sm border-b border-gray-100">
                <h3 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-bag-shopping text-blue-600"></i> Tu Bolsa</h3>
                <button onclick="toggleCart()" class="text-gray-400 hover:text-slate-800 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="cart-items-container" class="flex-1 p-5 overflow-y-auto bg-gray-50"></div>
            <div class="p-6 bg-white border-t border-gray-200 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                <div class="flex justify-between items-center mb-2 text-sm text-gray-500"><span>Subtotal</span><span id="cart-subtotal" class="text-slate-800 font-bold">$0.00</span></div>
                <div class="flex justify-between items-center mb-4 text-sm text-gray-500"><span>Env√≠o</span><span id="cart-shipping" class="text-slate-800 font-bold">--</span></div>
                <div class="flex justify-between items-center mb-6 text-2xl font-bold text-slate-800 border-t border-gray-100 pt-4"><span>Total</span><span id="cart-total" class="text-blue-600">$0.00</span></div>
                
                <div id="checkout-form" class="hidden space-y-3 mb-4">
                    <input type="text" id="cust-name" placeholder="Tu Nombre" class="w-full bg-gray-50 p-3 rounded-xl text-slate-800 border border-gray-200 focus:border-blue-500 outline-none transition">
                    
                    <div class="relative">
                        <input type="tel" id="cust-phone" placeholder="Tel√©fono" class="w-full bg-gray-50 p-3 rounded-xl text-slate-800 border border-gray-200 focus:border-blue-500 outline-none transition">
                        <div id="locked-phone-icon" class="hidden absolute right-3 top-3 text-green-500 text-sm" title="Verificado"><i class="fa-solid fa-circle-check"></i></div>
                    </div>

                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500 font-bold uppercase">Direcci√≥n</span>
                            <button onclick="getLocation()" class="text-[10px] bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded transition"><i class="fa-solid fa-location-crosshairs"></i> Usar GPS</button>
                        </div>
                        <div id="location-result" class="text-xs mb-2 text-green-600 font-mono"></div>
                        <textarea id="cust-address" placeholder="Calle, N√∫mero, Colonia..." class="w-full bg-white p-2 text-sm rounded-lg text-slate-800 border border-gray-200 focus:border-blue-500 outline-none resize-none" rows="2"></textarea>
                    </div>
                    
                    <div class="mt-4">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-2">M√©todo de Pago</p>
                        <div class="flex gap-3">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="pay" value="Transferencia" class="peer sr-only" checked onchange="togglePay()">
                                <div class="bg-white peer-checked:bg-blue-50 peer-checked:border-blue-400 border border-gray-200 rounded-xl p-3 text-center text-xs transition text-gray-600 peer-checked:text-blue-700 hover:bg-gray-50">
                                    <i class="fa-solid fa-building-columns mb-1 block text-lg"></i> Transferencia
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="pay" value="Efectivo" class="peer sr-only" onchange="togglePay()">
                                <div class="bg-white peer-checked:bg-green-50 peer-checked:border-green-400 border border-gray-200 rounded-xl p-3 text-center text-xs transition text-gray-600 peer-checked:text-green-700 hover:bg-gray-50">
                                    <i class="fa-solid fa-money-bill-wave mb-1 block text-lg"></i> Efectivo
                                </div>
                            </label>
                        </div>
                        <div id="pay-trans" class="mt-3 text-xs text-blue-700 bg-blue-50 border border-blue-200 p-3 rounded-lg">
                            <p class="mb-1">Banco: <span id="disp-bank-name" class="font-bold select-all"></span></p>
                            <p>CLABE: <span id="disp-bank-clabe" class="font-bold select-all font-mono tracking-wide"></span></p>
                        </div>
                        <div id="pay-cash" class="hidden mt-3 text-xs text-green-700 bg-green-50 border border-green-200 p-3 rounded-lg">
                            <p>Pagas al recibir. Por favor ten cambio listo.</p>
                        </div>
                    </div>
                </div>
                <button onclick="handleCheckout()" id="checkout-btn" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 text-lg">
                    <span>Enviar Pedido</span> <i class="fa-brands fa-whatsapp text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- IA Modal (PREMIUM DESIGN Light) -->
    <div id="ai-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl border border-gray-100 overflow-hidden flex flex-col h-[600px] animate-fade-in relative chat-container-premium">
            <!-- Header -->
            <div class="bg-white/80 backdrop-blur-md p-4 border-b border-gray-100 flex justify-between items-center z-10 sticky top-0">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg shadow-purple-500/20">
                            <i class="fa-solid fa-robot text-white text-lg"></i>
                        </div>
                        <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></span>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800 text-sm">IA Chef</h3>
                        <p class="text-[10px] text-blue-600 flex items-center gap-1"><span class="w-1 h-1 bg-blue-600 rounded-full animate-pulse"></span> En l√≠nea</p>
                    </div>
                </div>
                <button onclick="toggleAI()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-500 flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <!-- Chat Area -->
            <div id="chat-container" class="flex-1 p-4 overflow-y-auto flex flex-col gap-3 relative z-0">
                <!-- Messages will appear here -->
            </div>
            
            <!-- Input Area (Simulated) -->
            <div class="p-4 bg-white border-t border-gray-100 z-10">
                <div class="text-[10px] text-center text-gray-400 mb-2">Potenciado por MenuIA Neural Engine‚Ñ¢</div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur border border-slate-700 text-white px-6 py-3 rounded-full opacity-0 pointer-events-none transition-all duration-300 z-[70] flex items-center gap-3 translate-y-10 shadow-xl">
        <i class="fa-solid fa-circle-check text-green-400 text-lg"></i> <span id="toast-msg" class="font-medium text-sm">Notificaci√≥n</span>
    </div>

    <script>
        const API_URL = "https://menuia.onrender.com";
        let socket;
        try { socket = io(API_URL); } catch(e) { console.warn("Socket no disponible"); }
        
        let SHOP_CONFIG = {}, MENU_DATA = {}, cart = [], userLocation = null, distanceKm = 0;
        let allItems = []; 
        let idleTimer, idleWarningShown = false;
        
        const urlParams = new URLSearchParams(window.location.search);
        let pathSlug = window.location.pathname.split('/').pop();
        if(pathSlug.endsWith('.html')) pathSlug = pathSlug.replace('.html', '');
        
        const SHOP_SLUG = urlParams.get('slug') || pathSlug || 'sosushi';
        
        let pendingItem = null;
        let USER_DATA = JSON.parse(localStorage.getItem('menuia_user_data')) || null;
        let ACTIVE_ORDER = JSON.parse(localStorage.getItem('menuia_active_order_' + SHOP_SLUG)) || null;

        // --- CONTEXT AWARENESS & AI ENGINE ---
        function initContextAwareness() {
            const hour = new Date().getHours();
            let greeting = "Bienvenido";
            let contextIcon = "fa-sun";
            let contextText = "Men√∫ del D√≠a";

            if (hour >= 5 && hour < 12) { 
                greeting = "Buenos D√≠as"; contextIcon = "fa-mug-hot"; contextText = "Desayunos";
            } else if (hour >= 12 && hour < 18) { 
                greeting = "Hora de Comer"; contextIcon = "fa-utensils"; contextText = "Almuerzo";
            } else if (hour >= 18 || hour < 5) { 
                greeting = "Buenas Noches"; contextIcon = "fa-moon"; contextText = "Cena & Antojos";
            }

            document.getElementById('hero-title').innerText = greeting.toUpperCase();
            document.getElementById('context-text').innerText = contextText;
            document.querySelector('#context-badge i').className = `fa-regular ${contextIcon} text-yellow-500 animate-spin-slow`;
        }

        // --- SOCKET LOGIC ---
        if(socket) {
            socket.on('connect', () => { socket.emit('join-store', SHOP_SLUG); });
            socket.on('shop-updated', async () => { await loadStoreData(); showToast("Men√∫ actualizado"); });
            
            socket.on('order-created-client', (order) => {
                const myPhone = USER_DATA ? USER_DATA.phone : (ACTIVE_ORDER?.customerPhone);
                if (order.customerPhone === myPhone) {
                    saveActiveOrder(order);
                    if(USER_DATA) {
                        showToast("¬°Pedido Recibido!");
                        checkActiveOrder();
                    }
                }
            });

            socket.on('order-status-updated', (data) => {
                if (ACTIVE_ORDER && data.orderId === ACTIVE_ORDER._id) {
                    if (USER_DATA && ACTIVE_ORDER.customerPhone !== USER_DATA.phone) return;

                    ACTIVE_ORDER.status = data.status;
                    localStorage.setItem('menuia_active_order_' + SHOP_SLUG, JSON.stringify(ACTIVE_ORDER));
                    
                    if (data.status === 'completed') {
                        showToast("¬°Pedido Entregado! üéâ");
                        setTimeout(() => checkActiveOrder(), 5000); 
                    } else {
                        updateTrackerUI(data.status);
                        showToast(`Estado: ${translateStatus(data.status)}`);
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const l = document.getElementById('app-loader');
                if(l) { l.style.opacity = '0'; setTimeout(()=>l.remove(), 500); }
            }, 1500); 
            
            loadStoreData();
            resetIdleTimer();
            initUser();
            checkActiveOrder();
            initContextAwareness();
        });

        // --- TRACKER LOGIC ---
        function checkActiveOrder() {
            const isUserLoggedIn = !!USER_DATA;
            const hasActiveOrder = ACTIVE_ORDER && ACTIVE_ORDER.status !== 'completed';
            const isMyOrder = hasActiveOrder && isUserLoggedIn && ACTIVE_ORDER.customerPhone === USER_DATA.phone;

            const banner = document.getElementById('tracker-header');
            const card = document.getElementById('active-order-card');
            const indicator = document.getElementById('nav-order-indicator');
            
            if (isMyOrder) {
                banner.classList.remove('hidden');
                if(card) card.classList.remove('hidden');
                if(indicator) indicator.classList.remove('hidden');
                updateTrackerUI(ACTIVE_ORDER.status);
            } else {
                banner.classList.add('hidden');
                if(card) card.classList.add('hidden');
                if(indicator) indicator.classList.add('hidden');
            }
        }

        function saveActiveOrder(order) {
            ACTIVE_ORDER = order;
            localStorage.setItem('menuia_active_order_' + SHOP_SLUG, JSON.stringify(ACTIVE_ORDER));
            checkActiveOrder();
        }

        function translateStatus(s) {
            const map = { 'pending': 'Confirmado', 'preparing': 'Cocinando', 'ready': 'Listo', 'delivering': 'En Camino', 'completed': 'Entregado' };
            return map[s] || s;
        }

        function updateTrackerUI(status) {
            if(!USER_DATA) return;

            const steps = ['pending', 'preparing', 'ready', 'delivering'];
            let activeIndex = steps.indexOf(status);
            if(status === 'completed') activeIndex = 4;

            const displayId = `ORDEN #${(ACTIVE_ORDER.dailyId || '...').toString().slice(-4)}`;
            const statusText = translateStatus(status);
            
            document.getElementById('header-order-id').innerText = displayId;
            document.getElementById('header-tracker-status').innerText = statusText;
            
            let percentage = 10;
            let iconClass = "fa-fire-burner";
            
            if(status === 'pending') { percentage = 25; iconClass = "fa-clipboard-check"; }
            else if(status === 'preparing') { percentage = 50; iconClass = "fa-fire"; }
            else if(status === 'ready') { percentage = 75; iconClass = "fa-box-open"; }
            else if(status === 'delivering') { percentage = 90; iconClass = "fa-motorcycle"; }
            else if(status === 'completed') { percentage = 100; iconClass = "fa-flag-checkered"; }
            
            document.getElementById('header-progress-bar').style.width = `${percentage}%`;
            document.getElementById('header-progress-text').innerText = `${percentage}%`;
            document.getElementById('header-status-icon').className = `fa-solid ${iconClass} text-blue-600 text-lg animate-pulse`;

            const modalStatusTxt = document.getElementById('tracker-status-text');
            if(modalStatusTxt) modalStatusTxt.innerText = statusText;
            
            const modalId = document.getElementById('tracker-order-id');
            if(modalId) modalId.innerText = displayId;

            steps.forEach((s, i) => {
                const el = document.getElementById(`step-${s}`);
                if(el) {
                    el.classList.remove('active', 'completed');
                    if(i < activeIndex) el.classList.add('completed');
                    else if (i === activeIndex) el.classList.add('active');
                }
            });
        }

        // --- AUTH & USER LOGIC ---
        function initUser() { updateUserUI(); }

        function switchAuthTab(tab) {
            const l = document.getElementById('form-login');
            const r = document.getElementById('form-register');
            const lb = document.getElementById('tab-login');
            const rb = document.getElementById('tab-register');
            
            if(tab === 'login') {
                l.classList.remove('hidden'); r.classList.add('hidden');
                lb.className = "flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition";
                rb.className = "flex-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 transition";
            } else {
                l.classList.add('hidden'); r.classList.remove('hidden');
                rb.className = "flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition";
                lb.className = "flex-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 transition";
            }
        }

        async function handleUserLogin() {
            const phone = document.getElementById('login-phone').value;
            const password = document.getElementById('login-pass').value;
            const btn = document.querySelector('#form-login button');
            const originalText = btn.innerText;
            btn.innerText = "Verificando..."; btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}/api/customer/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ phone, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    USER_DATA = data.customer;
                    USER_DATA.password = password; 
                    localStorage.setItem('menuia_user_data', JSON.stringify(USER_DATA));
                    updateUserUI();
                    checkActiveOrder();
                    showToast(`¬°Hola, ${USER_DATA.name.split(' ')[0]}!`);
                    toggleUserModal();
                } else {
                    alert(data.error || "Datos incorrectos");
                }
            } catch (e) { alert("Error de conexi√≥n"); }
            btn.innerText = originalText; btn.disabled = false;
        }

        async function handleUserRegister() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const address = document.getElementById('reg-address').value;
            const password = document.getElementById('reg-pass').value;
            
            try {
                const res = await fetch(`${API_URL}/api/customer/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, phone, address, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    USER_DATA = { name, phone, address, password };
                    localStorage.setItem('menuia_user_data', JSON.stringify(USER_DATA));
                    updateUserUI();
                    checkActiveOrder();
                    showToast("¬°Cuenta creada!");
                    toggleUserModal();
                } else { alert(data.error || "Error al registrar"); }
            } catch (e) { alert("Error de conexi√≥n"); }
        }

        function logoutUser() {
            localStorage.removeItem('menuia_user_data');
            USER_DATA = null;
            updateUserUI();
            checkActiveOrder();
            showToast("Sesi√≥n cerrada");
        }

        function updateUserUI() {
            const loginForm = document.getElementById('form-login');
            const regForm = document.getElementById('form-register');
            const infoPanel = document.getElementById('user-info-panel');
            const tabs = document.querySelector('.bg-gray-50.border-b'); 

            if (USER_DATA) {
                document.getElementById('nav-user-name').innerText = USER_DATA.name.split(' ')[0];
                document.getElementById('display-user-name').innerText = USER_DATA.name;
                document.getElementById('display-user-phone').innerText = USER_DATA.phone;
                document.getElementById('user-initial').innerText = USER_DATA.name.charAt(0).toUpperCase();
                
                loginForm.classList.add('hidden');
                regForm.classList.add('hidden');
                if(tabs) tabs.classList.add('hidden');
                infoPanel.classList.remove('hidden');
            } else {
                document.getElementById('nav-user-name').innerText = "Ingresar";
                if(tabs) tabs.classList.remove('hidden');
                infoPanel.classList.add('hidden');
                switchAuthTab('login'); 
            }
        }
        function toggleUserModal() { document.getElementById('user-modal').classList.toggle('active'); }

        // --- CORE FUNCTIONS (Load, Render, Cart) ---
        async function loadStoreData() {
            try {
                if(socket) socket.emit('register-visit', SHOP_SLUG);
                const res = await fetch(`${API_URL}/api/shop/${SHOP_SLUG}`);
                if(!res.ok) throw new Error("Tienda no encontrada");
                
                const data = await res.json();
                SHOP_CONFIG = data.config || {}; 
                MENU_DATA = data.menu || {};
                
                allItems = [...(MENU_DATA.promos||[]), ...(MENU_DATA.especiales||[]), ...(MENU_DATA.clasicos||[]), ...(MENU_DATA.extras||[])];
                allItems.forEach(item => { if(!item.sales) item.sales = Math.floor(Math.random() * 100); });

                applyConfig(); 
                renderMenu('all');
            } catch (e) { console.error("Error loading store"); }
        }

        function applyConfig() {
            if(!SHOP_CONFIG.name) return; 
            document.title = SHOP_CONFIG.name;
            document.getElementById('brand-name').innerText = SHOP_CONFIG.name.toUpperCase();
            document.getElementById('hero-title').innerText = SHOP_CONFIG.name.toUpperCase();
            document.getElementById('hero-img').src = SHOP_CONFIG.heroImage || 'https://via.placeholder.com/800';
            
            const hoursDisplay = document.getElementById('hours-display');
            if(hoursDisplay) hoursDisplay.innerText = `Abierto ${SHOP_CONFIG.hours?.open || 9}:00 - ${SHOP_CONFIG.hours?.close || 22}:00`;
            
            if(SHOP_CONFIG.bank) {
                document.getElementById('disp-bank-name').innerText = SHOP_CONFIG.bank.name || 'N/A';
                document.getElementById('disp-bank-clabe').innerText = SHOP_CONFIG.bank.clabe || 'N/A';
            }
            
            const h = new Date().getHours();
            const isOpen = h >= (SHOP_CONFIG.hours?.open||9) && h < (SHOP_CONFIG.hours?.close||22);
            const banner = document.getElementById('status-banner');
            
            if(isOpen) {
                if (SHOP_CONFIG.highDemand) {
                    banner.innerText = `‚ö†Ô∏è ALTA DEMANDA - DEMORA: ${SHOP_CONFIG.highDemandTime || '45min'} ‚ö†Ô∏è`; 
                    banner.className = "bg-orange-500 text-white text-center py-1 text-xs font-bold tracking-wider uppercase";
                } else {
                    banner.innerText = "¬°ENVIOS DISPONIBLES AHORA!"; 
                    banner.className = "bg-green-600 text-white text-center py-1 text-xs font-bold tracking-wider uppercase";
                }
            } else {
                banner.innerText = "CERRADO - ABRE MA√ëANA"; 
                banner.className = "bg-red-500 text-white text-center py-1 text-xs font-bold tracking-wider uppercase";
            }
        }

        function renderMenu(filter) {
            const container = document.getElementById('menu-sections');
            container.innerHTML = '';
            let hasResults = false;

            const cats = ['promos', 'especiales', 'clasicos', 'extras'];
            const titles = SHOP_CONFIG.categoryTitles || {};

            if(filter === 'top') {
                const topItems = [...allItems].sort((a,b) => b.sales - a.sales).slice(0, 6);
                if(topItems.length) { hasResults = true; renderSection(container, "üèÜ Top Ventas", topItems); }
            } else {
                cats.forEach(key => {
                    let items = MENU_DATA[key] || [];
                    if(filter === 'promo') items = items.filter(i => (i.tags||[]).includes('promo') || key === 'promos');
                    
                    if(items.length > 0) {
                        hasResults = true;
                        renderSection(container, titles[key] || key.toUpperCase(), items);
                    }
                });
            }
            document.getElementById('no-results').classList.toggle('hidden', hasResults);
        }

        function renderSection(container, title, items) {
            const section = document.createElement('div');
            section.className = "mb-12 animate-fade-in";
            section.innerHTML = `
                <div class="flex items-center gap-3 mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">${title}</h2>
                    <div class="h-px flex-1 bg-gray-200"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${items.map(i => createCard(i)).join('')}
                </div>`;
            container.appendChild(section);
        }

        function createCard(item) {
            const isTop = item.sales > 80;
            const isPromo = (item.tags || []).includes('promo') || (item.originalPrice && item.originalPrice > item.price);
            let badges = '';
            if (isTop) badges += `<div class="badge-ai-match top-2 right-2"><i class="fa-solid fa-fire"></i> Top</div>`;
            if (isPromo) badges += `<div class="absolute top-2 left-2 bg-yellow-400 text-yellow-900 text-[10px] font-bold px-2 py-1 rounded-full shadow-sm">Oferta</div>`;
            
            const h = new Date().getHours();
            if (h > 18 && (item.tags||[]).includes('dinner')) badges += `<div class="badge-ai-match top-2 right-20 bg-purple-600"><i class="fa-solid fa-moon"></i> Cena</div>`;

            const priceDisplay = item.originalPrice > item.price 
                ? `<div class="flex flex-col items-end"><span class="text-xs text-slate-400 line-through">$${item.originalPrice}</span><span class="text-xl font-bold text-slate-800">$${item.price}</span></div>`
                : `<span class="text-xl font-bold text-slate-800">$${item.price}</span>`;

            const safeItem = JSON.stringify(item).replace(/'/g, "&#39;");

            return `
            <div class="sushi-card rounded-2xl overflow-hidden flex flex-col h-full relative group">
                ${badges}
                <div class="h-48 relative overflow-hidden bg-slate-100">
                    <img src="${item.image||'https://via.placeholder.com/300'}" class="w-full h-full object-cover transition duration-700 transform group-hover:scale-110" loading="lazy" onerror="this.src='https://via.placeholder.com/300?text=Sin+Imagen'">
                    <!-- Light gradient overlay -->
                    <div class="absolute inset-0 bg-gradient-to-t from-white via-transparent to-transparent opacity-20"></div>
                    <div class="absolute bottom-3 right-3 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-xl shadow-sm border border-slate-100">${priceDisplay}</div>
                </div>
                <div class="p-5 flex-1 flex flex-col">
                    <h3 class="font-bold text-lg text-slate-900 mb-1 leading-tight">${item.name}</h3>
                    <p class="text-slate-500 text-xs mb-4 line-clamp-2 flex-1">${item.description || ''}</p>
                    <button onclick='addToCart(${safeItem})' class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-xl font-bold mt-auto transition shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2 transform active:scale-95">
                        <i class="fa-solid fa-plus"></i> Agregar
                    </button>
                </div>
            </div>`;
        }

        // --- CART & CHECKOUT ---
        function toggleCart() { 
            if (USER_DATA) {
                document.getElementById('cust-name').value = USER_DATA.name;
                document.getElementById('cust-phone').value = USER_DATA.phone;
                document.getElementById('cust-phone').readOnly = true;
                document.getElementById('locked-phone-icon').classList.remove('hidden');
                document.getElementById('cust-address').value = USER_DATA.address || '';
            } else {
                document.getElementById('cust-phone').readOnly = false;
                document.getElementById('locked-phone-icon').classList.add('hidden');
            }
            document.getElementById('cart-modal').classList.toggle('active'); 
        }
        function toggleOptionsModal(show) {
            const m = document.getElementById('options-modal');
            if(show) m.classList.add('active'); else m.classList.remove('active');
        }
        function addToCart(item) {
            let options = item.options || [];
            if (item.groupId && MENU_DATA.groups) {
                const group = MENU_DATA.groups.find(g => g.id === item.groupId);
                if (group) options = group.options;
            }

            if(options && options.length > 0) {
                pendingItem = item;
                pendingItem.price = parseFloat(pendingItem.price); 
                const container = document.getElementById('options-list');
                container.innerHTML = options.map((opt, idx) => {
                    const name = typeof opt === 'object' ? opt.name : opt;
                    const price = typeof opt === 'object' ? (parseFloat(opt.price) || 0) : 0; 
                    const priceTxt = price > 0 ? `(+$${price})` : '';
                    return `<label class="flex items-center p-3 bg-slate-50 border border-gray-200 rounded-xl cursor-pointer hover:bg-blue-50 hover:border-blue-200 transition justify-between group"><div class="flex items-center"><input type="checkbox" value="${idx}" data-price="${price}" data-name="${name}" onchange="updateModalTotal()" class="option-check form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 mr-3"><span class="text-slate-700 font-medium">${name}</span></div>${price > 0 ? `<span class="text-blue-600 font-bold text-xs bg-blue-100 px-2 py-1 rounded">${priceTxt}</span>` : ''}</label>`;
                }).join('');
                updateModalTotal(); toggleOptionsModal(true);
            } else {
                addItemToCartInternal({ ...item, price: parseFloat(item.price) }, []);
            }
        }
        function updateModalTotal() {
            const checks = document.querySelectorAll('.option-check:checked');
            let extra = 0; checks.forEach(c => extra += parseFloat(c.dataset.price || 0));
            document.getElementById('modal-confirm-btn').innerText = `Agregar por $${(parseFloat(pendingItem.price) + extra).toFixed(2)}`;
        }
        function confirmOptions() {
            const checks = document.querySelectorAll('.option-check:checked');
            const selectedNames = []; let extraCost = 0;
            checks.forEach(c => {
                const price = parseFloat(c.dataset.price || 0); extraCost += price;
                selectedNames.push(price > 0 ? `${c.dataset.name} (+$${price})` : c.dataset.name);
            });
            addItemToCartInternal({ ...pendingItem, price: parseFloat(pendingItem.price) + extraCost }, selectedNames);
            toggleOptionsModal(false);
        }
        function addItemToCartInternal(item, options) {
            const optionsKey = options.sort().join('|');
            const ex = cart.find(i => i.name === item.name && (i.selectedOptions || []).sort().join('|') === optionsKey);
            if(ex) ex.qty++; else cart.push({...item, qty:1, selectedOptions: options});
            updateCart(); showToast("Agregado a la bolsa"); confetti({particleCount:30, origin:{y:0.8}, colors: ['#3b82f6', '#10b981']});
        }
        function updateCart() {
            document.getElementById('cart-count').innerText = cart.reduce((a,b)=>a+b.qty,0);
            const c = document.getElementById('cart-items-container');
            if(cart.length === 0) {
                c.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400 space-y-4"><i class="fa-solid fa-basket-shopping text-6xl opacity-20"></i><p>Tu bolsa est√° vac√≠a</p></div>`;
                document.getElementById('checkout-form').classList.add('hidden');
                document.getElementById('checkout-btn').classList.add('hidden');
                document.getElementById('cart-total').innerText = "$0.00";
                return;
            }
            document.getElementById('checkout-btn').classList.remove('hidden');
            document.getElementById('checkout-form').classList.remove('hidden');
            
            c.innerHTML = cart.map((i, idx) => {
                const optsHtml = i.selectedOptions && i.selectedOptions.length > 0 ? `<div class="text-[10px] text-blue-500 mt-1 font-medium">+ ${i.selectedOptions.join(', ')}</div>` : '';
                return `<div class="flex items-center gap-4 mb-4 bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                    <img src="${i.image||'https://via.placeholder.com/100'}" class="w-16 h-16 rounded-lg object-cover bg-gray-100">
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-bold text-slate-800 truncate">${i.name}</h4>
                        ${optsHtml}
                        <div class="flex items-center gap-3 mt-2">
                            <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200">
                                <button onclick="changeQty(${idx}, -1)" class="w-7 h-7 text-gray-500 hover:text-slate-800 hover:bg-gray-200 rounded-l-lg transition">-</button>
                                <span class="text-xs font-bold w-4 text-center text-slate-800">${i.qty}</span>
                                <button onclick="changeQty(${idx}, 1)" class="w-7 h-7 text-gray-500 hover:text-slate-800 hover:bg-gray-200 rounded-r-lg transition">+</button>
                            </div>
                            <span class="text-sm font-bold text-blue-600">$${(i.price * i.qty).toFixed(2)}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            let total = cart.reduce((a,b)=>a + (parseFloat(b.price) * b.qty), 0);
            let shipping = 0; 
            if(userLocation && distanceKm <= (SHOP_CONFIG.shipping?.maxRadius || 10)) {
                shipping = (total >= (SHOP_CONFIG.shipping?.freeThreshold || 9999)) ? 0 : Math.ceil(distanceKm * (SHOP_CONFIG.shipping?.costPerKm || 10));
            }
            document.getElementById('cart-subtotal').innerText = `$${total.toFixed(2)}`;
            document.getElementById('cart-shipping').innerText = userLocation ? `$${shipping}` : "--";
            document.getElementById('cart-total').innerText = `$${(total + shipping).toFixed(2)}`;
        }
        function changeQty(index, delta) {
            const item = cart[index]; if(item) { item.qty += delta; if(item.qty <= 0) cart.splice(index, 1); updateCart(); }
        }
        function togglePay() {
            const m = document.querySelector('input[name="pay"]:checked').value;
            document.getElementById('pay-cash').classList.toggle('hidden', m!=='efectivo');
            document.getElementById('pay-trans').classList.toggle('hidden', m!=='transferencia');
        }
        function getLocation() {
            const b = event.target; const ogHtml = b.innerHTML; b.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>';
            navigator.geolocation.getCurrentPosition(p=>{
                userLocation={lat:p.coords.latitude, lng:p.coords.longitude};
                distanceKm = 2.5; 
                document.getElementById('location-result').innerText = `üìç Ubicaci√≥n detectada (Precisi√≥n: Alta)`;
                b.innerHTML = ogHtml;
                updateCart();
            }, ()=>{ alert("Activa el GPS"); b.innerHTML = ogHtml; });
        }

        function handleCheckout() {
            const n = document.getElementById('cust-name').value;
            const p = document.getElementById('cust-phone').value;
            const a = document.getElementById('cust-address').value;
            if(!n || !p || !a) return alert("Por favor completa tus datos de entrega.");
            
            if(!USER_DATA) {
                if(!confirm("‚ö†Ô∏è Est√°s ordenando como Invitado.\n\nPara poder RASTREAR tu pedido en tiempo real, te recomendamos Iniciar Sesi√≥n o Crear Cuenta primero.\n\n¬øDeseas continuar de todos modos?")) return;
            }

            let method = document.querySelector('input[name="pay"]:checked').value;
            let m = `*NUEVO PEDIDO - ${SHOP_CONFIG.name}*\n----------------\nüë§ ${n}\nüìû ${p}\nüìç ${a}\nüí≥ Pago: ${method}\n----------------\n`;
            cart.forEach(i=> {
                const opts = i.selectedOptions ? ` (${i.selectedOptions.join(', ')})` : '';
                m+=`${i.qty}x ${i.name}${opts} - $${(i.price*i.qty).toFixed(2)}\n`;
            });
            const total = document.getElementById('cart-total').innerText;
            m+=`\nüí∞ *TOTAL: ${total}*`;
            
            window.open(`https://wa.me/521${SHOP_CONFIG.whatsapp}?text=${encodeURIComponent(m)}`, '_blank');
            
            if(socket) {
                const orderPayload = {
                    slug: SHOP_SLUG,
                    order: {
                        ref: n,
                        customerPhone: p, 
                        address: a,
                        paymentMethod: method,
                        type: 'domicilio',
                        items: cart,
                        total: total,
                        status: 'pending'
                    }
                };
                socket.emit('register-order', orderPayload);
                
                saveActiveOrder({
                    _id: 'TEMP-' + Date.now(),
                    dailyId: '...',
                    status: 'pending',
                    customerPhone: p,
                    total: total
                });
            }
            
            cart = []; updateCart(); toggleCart();
            showToast("Procesando pedido...");
        }

        function showToast(m) { 
            const t=document.getElementById('toast'); 
            document.getElementById('toast-msg').innerText=m; 
            t.style.opacity=1; t.style.transform='translate(-50%,0)'; 
            setTimeout(()=>{t.style.opacity=0; t.style.transform='translate(-50%,20px)'},3000); 
        }
        function resetIdleTimer() { clearTimeout(idleTimer); if(!idleWarningShown) idleTimer=setTimeout(()=>{showToast("üí° ¬øNo te decides? Prueba nuestra IA Chef"); idleWarningShown=true}, 20000); }
        
        // --- ADVANCED AI CHATBOT (NEURAL ENGINE Light) ---
        
        let aiState = { step: 0, scores: {} };
        const questions = [
            { id: 'mood', text: "¬øCu√°l es tu mood hoy?", opts: [
                { txt: "üòé Relax / Chill", tags: ['clasicos', 'comfort'], w: 2 },
                { txt: "üí™ Fitness / Ligero", tags: ['extras', 'salad', 'light'], w: 3 },
                { txt: "üéâ Fiesta / Hambre", tags: ['promos', 'share', 'heavy'], w: 2 }
            ]},
            { id: 'taste', text: "¬øQu√© se te antoja m√°s?", opts: [
                { txt: "üå∂Ô∏è Algo Picosito", tags: ['spicy', 'hot'], w: 3 },
                { txt: "üç£ Fresco / Sushi", tags: ['sushi', 'fresh', 'cold'], w: 3 },
                { txt: "üçñ Carn√≠voro", tags: ['meat', 'heavy'], w: 2 }
            ]}
        ];

        function toggleAI() { 
            const m=document.getElementById('ai-modal'); 
            m.classList.toggle('active'); 
            if(m.classList.contains('active')) startAIChat(); 
        }

        function startAIChat() {
            const c=document.getElementById('chat-container'); c.innerHTML=''; 
            allItems.forEach(i => aiState.scores[i.name] = 0);
            aiState.step = 0;
            
            const h = new Date().getHours();
            let greeting = "¬°Hola! Soy tu Chef Virtual ü§ñ.";
            if(h < 12) greeting += " ¬øBuscas desayunar rico?";
            else if(h > 18) greeting += " ¬øCenamos algo delicioso?";
            
            addMsg(greeting, true);
            setTimeout(() => nextQuestion(), 800);
        }

        function nextQuestion() {
            if (aiState.step < questions.length) {
                const q = questions[aiState.step];
                addMsg(q.text, true);
                addOpts(q.opts, (opt) => {
                    allItems.forEach(item => {
                        const itemTags = (item.tags || []).join(' ').toLowerCase();
                        opt.tags.forEach(t => {
                            if(itemTags.includes(t)) aiState.scores[item.name] += opt.w;
                        });
                        aiState.scores[item.name] += Math.random() * 0.5;
                    });
                    aiState.step++;
                    setTimeout(() => nextQuestion(), 500);
                });
            } else {
                showAIResult();
            }
        }

        function showAIResult() {
            addMsg("Analizando tus gustos... üß†", true);
            setTimeout(() => {
                let winner = null, maxScore = -1;
                allItems.forEach(i => {
                    if (aiState.scores[i.name] > maxScore) { maxScore = aiState.scores[i.name]; winner = i; }
                });

                if(!winner) winner = allItems[0]; 

                const matchPct = Math.min(98, Math.floor(85 + (maxScore * 2)));

                addMsg(`¬°Lo tengo! Con un ${matchPct}% de coincidencia para ti:`, true);
                
                const c = document.getElementById('chat-container');
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl border border-blue-100 shadow-xl animate-fade-in mt-2";
                card.innerHTML = `
                    <div class="relative h-32 rounded-xl overflow-hidden mb-3 bg-slate-100">
                        <img src="${winner.image}" class="w-full h-full object-cover">
                        <div class="absolute top-2 right-2 badge-ai-match"><i class="fa-solid fa-fingerprint"></i> ${matchPct}% Match</div>
                    </div>
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-slate-800 text-lg">${winner.name}</h4>
                        <span class="text-blue-600 font-bold">$${winner.price}</span>
                    </div>
                    <p class="text-slate-500 text-xs mt-1 mb-3 line-clamp-2">${winner.description || 'Una excelente elecci√≥n para tu gusto.'}</p>
                    <button onclick='addToCart(${JSON.stringify(winner).replace(/'/g,"&#39;")}); toggleAI()' class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition">¬°Lo quiero!</button>
                `;
                c.appendChild(card);
                c.scrollTop = c.scrollHeight;
                
                addOpts([{txt: "üîÑ Probar de nuevo", w:0, tags:[]}], () => startAIChat());

            }, 1500);
        }

        function addMsg(txt,bot){ const c=document.getElementById('chat-container'); c.innerHTML+=`<div class="chat-bubble ${bot?'bot':'user'}">${txt}</div>`; c.scrollTop=c.scrollHeight; }
        function addOpts(opts, callback){ 
            const c=document.getElementById('chat-container'); 
            const d=document.createElement('div'); d.className="chat-options"; 
            opts.forEach(o=>{ 
                const b=document.createElement('button'); b.className="chat-option-btn"; b.innerText=o.txt; 
                b.onclick=()=>{ d.remove(); addMsg(o.txt,false); callback(o); }; 
                d.appendChild(b); 
            }); 
            c.appendChild(d); c.scrollTop=c.scrollHeight; 
        }
    </script>
</body>
</html>
