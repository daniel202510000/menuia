<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men煤 - Detalles del Comercio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fcfcfc;
            /* Lighter gray/white */
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        .modal {
            transition: opacity 0.3s ease, visibility 0.3s;
            opacity: 0;
            visibility: hidden;
            z-index: 9999;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        /* Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }

        .rank-number {
            font-family: 'Inter', sans-serif;
            -webkit-text-stroke: 1px #fff;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>

<body class="bg-gray-50 pb-28">

    <!-- LOADER -->
    <div id="page-loader" class="fixed inset-0 bg-white z-[99999] flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 text-sm font-medium animate-pulse">Cargando men煤 delicioso...</p>
    </div>

    <!-- HEADER (Sticky) -->
    <header class="sticky top-0 z-50 bg-white" id="main-header">
        <!-- Top Nav -->
        <div class="flex items-center justify-between px-4 py-3 bg-white">
            <a href="index.html" class="w-8 h-8 flex items-center justify-center transition text-slate-800">
                <i class="fa-solid fa-chevron-left text-xl"></i>
            </a>

            <!-- Search Bar Wrapper in Header (initially hidden or integrated? Let's do integrated like Didi) -->
            <div class="flex-1 mx-3">
                <div class="relative">
                    <i
                        class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input type="text" placeholder="Buscar productos" id="global-search"
                        oninput="filterProducts(this.value)"
                        class="w-full bg-gray-100/80 rounded-full pl-9 pr-4 py-2.5 text-sm text-gray-700 font-medium focus:outline-none focus:bg-gray-100 transition">
                </div>
            </div>

            <button class="w-8 h-8 flex items-center justify-center text-slate-800">
                <i class="fa-regular fa-heart text-xl"></i>
            </button>
        </div>

        <!-- Info Mini Banner (Sticky context) - Optional, similar to Didi small summary if scrolled -->
    </header>

    <!-- SHOP INFO SECTION -->
    <div class="bg-white pb-2 mb-2">
        <div class="px-4 pt-1 mb-4">
            <!-- Time/Cost Badge -->
            <div class="flex items-center justify-between bg-gray-50 rounded-xl p-3 mb-4">
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-slate-900" id="store-time">-- Min</span>
                    <div class="text-[10px] text-gray-400 flex items-center gap-1">
                        <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                        <span id="store-shipping-text">Env铆o --</span>
                    </div>
                </div>
                <span class="font-bold text-slate-800 text-sm" id="store-fee">MX$--</span>
            </div>

            <!-- Didi Club / Promo Banner Mock -->
            <div class="bg-orange-100 rounded-lg p-3 flex justify-between items-center relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center gap-1 mb-0.5">
                        <i class="fa-solid fa-ticket text-orange-600 text-xs"></i>
                        <span class="text-xs font-bold text-orange-700">Env铆o gratis</span>
                    </div>
                    <span class="text-[10px] font-bold bg-orange-600 text-white px-1.5 py-0.5 rounded">DiDi Club</span>
                    <span class="text-[10px] text-orange-800 font-medium ml-1">Registrarse</span>
                </div>
                <!-- Decor Circles -->
                <div class="absolute -right-2 -bottom-4 w-12 h-12 bg-orange-200 rounded-full blur-md"></div>
            </div>
        </div>
    </div>

    <!-- MAIN SCROLLABLE CONTENT -->
    <main class="min-h-screen" id="main-container">

        <!-- PROMOTIONS SECTION (Horizontal) -->
        <div id="promos-section" class="mb-6 pl-4">
            <h3 class="font-bold text-lg text-slate-900 mb-3">Promociones</h3>
            <div id="promos-container" class="flex gap-3 overflow-x-auto no-scrollbar pr-4">
                <!-- JS Injected -->
            </div>
        </div>

        <!-- FAVORITES SECTION (Top 3) -->
        <div id="favorites-section" class="mb-6 pl-4">
            <h3 class="font-bold text-lg text-slate-900 mb-3">Favoritos</h3>
            <div id="favorites-container" class="flex gap-3 overflow-x-auto no-scrollbar pr-4">
                <!-- JS Injected -->
            </div>
        </div>

        <!-- CATEGORY TABS (Sticky) -->
        <div class="sticky top-[70px] z-40 bg-white pt-2 pb-3 pl-4 border-b border-gray-100/50" id="category-tabs">
            <div class="flex gap-2 overflow-x-auto no-scrollbar pr-4" id="categories-list">
                <!-- JS Injected Pills -->
            </div>
        </div>

        <!-- MENU ITEMS LIST -->
        <div class="px-4 pt-4 pb-20 space-y-8" id="menu-container">
            <!-- JS Injected -->
            <div class="text-center py-10 text-gray-400">
                <i class="fa-solid fa-utensils text-2xl mb-2"></i>
                <p>Cargando men煤...</p>
            </div>
        </div>

    </main>


    <!-- FLOATING CART BUTTON -->
    <div id="floating-cart"
        class="fixed bottom-6 left-4 right-4 bg-orange-600 text-white rounded-full shadow-2xl p-0 flex justify-between items-center z-50 transform translate-y-32 transition-transform duration-300 cursor-pointer h-14 overflow-hidden"
        onclick="openCheckout()">

        <div class="h-full pl-6 flex flex-col justify-center">
            <span class="font-extrabold text-base" id="cart-total">$0.00</span>
            <span class="text-[10px] text-orange-100 font-medium leading-none" id="cart-savings">Ahorraste $0.00</span>
        </div>

        <div class="h-full pr-6 flex items-center gap-2 bg-black/10 px-6">
            <span class="font-bold text-sm">Carrito</span>
            <div class="bg-white text-orange-600 w-5 h-5 rounded-full flex items-center justify-center font-bold text-xs"
                id="cart-count">0</div>
        </div>
    </div>


    <!-- PRODUCT DETAIL MODAL -->
    <div id="product-modal"
        class="modal fixed inset-0 z-[60] flex items-end justify-center bg-black/60 backdrop-blur-[2px]">
        <div class="modal-content bg-white w-full max-w-md rounded-t-[2rem] h-[92vh] flex flex-col relative shadow-2xl">

            <!-- Close Btn -->
            <button onclick="closeProductModal()"
                class="absolute top-4 left-4 z-20 w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center text-slate-900">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
            <button
                class="absolute top-4 right-4 z-20 w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center text-slate-900">
                <i class="fa-solid fa-share-nodes text-sm"></i>
            </button>

            <!-- Image Header -->
            <div class="h-72 w-full shrink-0 relative bg-gray-100">
                <img id="detail-img" src="" class="w-full h-full object-cover">
                <div class="absolute inset-x-0 bottom-0 h-20 bg-gradient-to-t from-white to-transparent"></div>
            </div>

            <!-- Content -->
            <div class="px-6 flex-1 overflow-y-auto no-scrollbar -mt-6 relative z-10">
                <div class="flex justify-between items-start mb-2">
                    <h2 class="text-2xl font-bold text-slate-900 leading-tight w-[70%]" id="detail-title">Nombre</h2>
                </div>

                <p class="text-gray-500 text-sm leading-relaxed mb-6" id="detail-desc">Descripci贸n...</p>

                <div class="flex justify-between items-center mb-6">
                    <span class="text-3xl font-bold text-slate-900" id="detail-price">$0.00</span>
                    <!-- Old Price if exists -->
                </div>

                <div class="bg-gray-50 rounded-xl p-4 mb-6">
                    <h4 class="font-bold text-sm text-slate-800 mb-2">Adicionales populares</h4>
                    <p class="text-xs text-gray-400"> (Mock no funcional en demo) </p>
                </div>
            </div>

            <!-- Bottom Actions -->
            <div class="p-4 border-t border-gray-100 flex items-center gap-4 bg-white pb-8">
                <div class="flex items-center border border-gray-200 rounded-full h-12 px-2 shadow-sm">
                    <button onclick="adjustDetailQty(-1)"
                        class="w-10 h-full flex items-center justify-center text-slate-600 hover:text-orange-600 disabled:opacity-30 text-xl font-bold">-</button>
                    <span id="detail-qty" class="w-6 text-center font-bold text-slate-800">1</span>
                    <button onclick="adjustDetailQty(1)"
                        class="w-10 h-full flex items-center justify-center text-slate-600 hover:text-orange-600 text-xl font-bold">+</button>
                </div>
                <button onclick="addToCartFromDetail()"
                    class="flex-1 h-12 bg-orange-600 text-white font-bold rounded-full shadow-xl shadow-orange-500/20 active:scale-95 transition flex justify-between px-6 items-center">
                    <span>Agregar</span>
                    <span id="detail-btn-total">$0.00</span>
                </button>
            </div>
        </div>
    </div>


    <!-- CHECKOUT MODAL -->
    <div id="checkout-modal" class="modal fixed inset-0 z-[70] bg-gray-50 overflow-y-auto">
        <!-- Header -->
        <div class="sticky top-0 bg-white px-4 py-4 flex items-center gap-4 shadow-sm z-10">
            <button onclick="closeCheckout()" class="text-slate-900 w-8 h-8 flex items-center justify-center -ml-2"><i
                    class="fa-solid fa-arrow-left text-xl"></i></button>
            <h2 class="font-bold text-lg">Tu pedido</h2>
        </div>

        <div class="p-4 space-y-4 pb-32">

            <!-- Address Card -->
            <div class="bg-white rounded-2xl p-4 shadow-sm flex items-center justify-between cursor-pointer">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600">
                        <i class="fa-solid fa-location-dot"></i>
                    </div>
                    <div>
                        <p class="font-bold text-sm text-slate-900" id="checkout-address">Casa</p>
                        <p class="text-xs text-gray-400">Agregar detalles de entrega</p>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right text-xs text-gray-300"></i>
            </div>

            <!-- Items -->
            <div class="bg-white rounded-2xl p-4 shadow-sm">
                <h3 class="font-bold text-base mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-shop text-gray-400 text-xs"></i> <span id="checkout-store-name">Tienda</span>
                </h3>
                <div id="checkout-items-list" class="space-y-6"></div>
            </div>

            <!-- Tip -->
            <div class="bg-white rounded-2xl p-4 shadow-sm">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-sm">Propina para el repartidor</h3>
                    <div class="bg-orange-100 text-orange-700 text-[10px] font-bold px-2 py-0.5 rounded-full">100% para
                        ellos</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="setTip(0)"
                        class="tip-btn flex-1 py-3 rounded-xl bg-gray-100 text-xs font-bold text-gray-500 border-2 border-transparent transition">No</button>
                    <button onclick="setTip(10)"
                        class="tip-btn flex-1 py-3 rounded-xl bg-orange-50 text-xs font-bold text-orange-600 border-2 border-orange-500 transition">10%</button>
                    <button onclick="setTip(15)"
                        class="tip-btn flex-1 py-3 rounded-xl bg-gray-100 text-xs font-bold text-gray-500 border-2 border-transparent transition">15%</button>
                    <button onclick="setTip(20)"
                        class="tip-btn flex-1 py-3 rounded-xl bg-gray-100 text-xs font-bold text-gray-500 border-2 border-transparent transition">20%</button>
                </div>
            </div>

            <!-- Summary -->
            <div class="space-y-2 py-2">
                <div class="flex justify-between text-sm text-gray-600">
                    <span>Subtotal</span>
                    <span id="summ-products">$0.00</span>
                </div>
                <div class="flex justify-between text-sm text-gray-600">
                    <span>Env铆o</span>
                    <span id="summ-shipping">$0.00</span>
                </div>
                <div class="flex justify-between text-sm text-gray-600">
                    <span>Propina</span>
                    <span id="summ-tip">$0.00</span>
                </div>
                <div class="flex justify-between text-sm text-gray-600">
                    <span>Tarifa de servicio</span>
                    <span>$6.00</span>
                </div>
                <div class="flex justify-between text-base font-bold text-slate-900 pt-2 border-t border-gray-200 mt-2">
                    <span>Total</span>
                    <span id="final-total">$0.00</span>
                </div>
            </div>
        </div>

        <!-- Sticky Pay Button -->
        <div class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-[0_-5px_30px_rgba(0,0,0,0.1)] rounded-t-3xl">
            <div class="flex items-center gap-3 mb-4 cursor-pointer" onclick="openPaymentMethods()">
                <div class="w-8 h-5 rounded border border-gray-300 flex items-center justify-center bg-white shadow-sm">
                    <i class="fa-solid fa-money-bill text-green-600 text-xs"></i>
                </div>
                <span class="text-xs font-medium text-slate-700 underline decoration-dotted"
                    id="checkout-payment-label">Efectivo</span>
                <i class="fa-solid fa-chevron-down text-[10px] text-gray-400"></i>
            </div>
            <button onclick="submitOrder()"
                class="w-full bg-orange-600 text-white font-bold py-4 rounded-full shadow-lg shadow-orange-500/30 text-lg hover:bg-orange-700 active:scale-95 transition">
                Realizar pedido
            </button>
        </div>
    </div>

    <!-- PAYMENT SELECTION -->
    <div id="payment-modal"
        class="modal fixed inset-0 z-[80] flex items-end justify-center bg-black/60 backdrop-blur-sm">
        <div class="modal-content bg-white w-full max-w-md rounded-t-3xl p-6 pb-10">
            <h3 class="font-bold text-lg mb-6">M茅todo de pago</h3>
            <div class="space-y-3">
                <div onclick="selectPayment('Efectivo')"
                    class="flex items-center gap-4 p-4 rounded-xl border border-gray-200 hover:border-orange-500 bg-white cursor-pointer">
                    <i class="fa-solid fa-money-bill text-green-500 text-xl"></i>
                    <span class="font-bold text-slate-700">Efectivo</span>
                </div>
                <div onclick="selectPayment('Tarjeta')"
                    class="flex items-center gap-4 p-4 rounded-xl border border-gray-200 hover:border-orange-500 bg-white cursor-pointer">
                    <i class="fa-regular fa-credit-card text-blue-500 text-xl"></i>
                    <span class="font-bold text-slate-700">Tarjeta (Nuevo)</span>
                </div>
            </div>
            <button onclick="closePaymentMethods()"
                class="w-full mt-6 bg-gray-100 text-slate-600 font-bold py-3 rounded-xl">Cancelar</button>
        </div>
    </div>

    <script>
        const API_URL = "https://menuia.onrender.com";
        // const API_URL = "http://localhost:3000";

        let socket;
        let SHOP_DATA = null;
        let CART = [];
        let CURRENT_ITEM = null;
        let SELECTED_TIP = 10;
        let SELECTED_PAYMENT = 'Efectivo';
        let USER_ADDRESS = "Ubicaci贸n actual";
        let USER_PHONE = "5500000000";
        let ACTIVE_CATEGORY = '';

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('slug');

            if (!slug) {
                window.location.href = 'index.html';
                return;
            }

            const userData = JSON.parse(localStorage.getItem('menuia_user_data'));
            if (userData) {
                USER_ADDRESS = userData.address || "Mi ubicaci贸n";
                USER_PHONE = userData.phone;
            }

            initSocket(slug);
            fetchShop(slug);
        });

        function initSocket(slug) {
            try {
                socket = io(API_URL);
                socket.on('connect', () => {
                    if (slug) socket.emit('join-store', slug);
                });
                socket.on('order-created-client', (order) => {
                    alert(`隆Pedido Enviado! \nRef: ${order.ref}`);
                    CART = [];
                    updateCartUI();
                    closeCheckout();
                    window.location.href = 'index.html';
                });
            } catch (e) { console.error("Socket error", e); }
        }

        async function fetchShop(slug) {
            try {
                const res = await fetch(`${API_URL}/api/shop/${slug}`);
                if (!res.ok) throw new Error("Tienda no encontrada");
                SHOP_DATA = await res.json();
                renderShop();
                document.getElementById('page-loader').classList.add('hidden');
            } catch (e) {
                alert("Error cargando la tienda");
                // window.location.href = 'index.html';
            }
        }

        function renderShop() {
            const config = SHOP_DATA.config;
            const menu = SHOP_DATA.menu;

            // Info
            document.getElementById('store-time').innerText = "30-45 Min";
            document.getElementById('store-shipping-text').innerText = `Env铆o $${config.shipping?.costPerKm || 15}`;
            document.getElementById('store-fee').innerText = `MX$${config.shipping?.costPerKm || 15}.00`;
            document.getElementById('checkout-store-name').innerText = config.name;


            // 1. PROMOTIONS
            const promos = menu.promos || [];
            if (promos.length > 0) {
                document.getElementById('promos-container').innerHTML = promos.map(p => `
                    <div onclick='openDetail(${JSON.stringify(p).replace(/'/g, "&#39;")})' class="min-w-[260px] h-36 bg-orange-50 rounded-lg relative overflow-hidden cursor-pointer flex border border-orange-100">
                        <div class="w-[55%] p-3 flex flex-col justify-center relative z-10">
                            <span class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full self-start mb-2 shadow-sm">25% OFF</span>
                            <h4 class="font-bold text-slate-800 text-sm leading-tight line-clamp-2 mb-1">${p.name}</h4>
                            <div class="flex items-center gap-2">
                                <span class="text-orange-600 font-bold">$${p.price}</span>
                                ${p.oldPrice ? `<span class="text-[10px] text-gray-400 line-through">$${p.oldPrice}</span>` : ''}
                            </div>
                        </div>
                        <div class="w-[45%] h-full relative">
                            <!-- Decor shape -->
                            <div class="absolute inset-0 bg-gradient-to-r from-orange-50 to-transparent z-10"></div>
                            <img src="${p.image || 'https://placehold.co/200'}" class="w-full h-full object-cover">
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('promos-section').style.display = 'none';
            }

            // 2. FAVORITES (Top 3)
            // Mock ranking based on "popular" or just first 3 of clasicos
            const allItems = [...(menu.clasicos || []), ...(menu.speciales || [])];
            // Take first 3 for demo
            const favorites = allItems.slice(0, 3);

            if (favorites.length > 0) {
                document.getElementById('favorites-container').innerHTML = favorites.map((p, idx) => `
                    <div onclick='openDetail(${JSON.stringify(p).replace(/'/g, "&#39;")})' class="min-w-[140px] w-[140px] cursor-pointer relative">
                         <div class="relative w-full h-32 rounded-xl overflow-hidden mb-2">
                            <img src="${p.image || 'https://placehold.co/150'}" class="w-full h-full object-cover">
                            <!-- RANK NUMBER -->
                            <span class="absolute -bottom-4 -left-1 text-[80px] font-bold text-green-500 leading-none rank-number drop-shadow-md z-10 italic">${idx + 1}</span>
                         </div>
                         <div class="pl-2 pt-2">
                            <h4 class="font-bold text-slate-900 text-sm text-center leading-snug line-clamp-1">${p.name}</h4>
                         </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('favorites-section').style.display = 'none';
            }


            // 3. CATEGORIES (Pills)
            // Order: Promo, Especiales, Clasicos, Extras
            const cats = ['promos', 'especiales', 'clasicos', 'extras'];
            const catContainer = document.getElementById('categories-list');
            const menuContainer = document.getElementById('menu-container');

            let catHtml = '';
            let menuHtml = '';

            cats.forEach(key => {
                const items = menu[key] || [];
                const title = config.categoryTitles?.[key] || key.charAt(0).toUpperCase() + key.slice(1);

                if (items.length > 0) {
                    // Pill
                    catHtml += `
                        <button onclick="scrollToCat('${key}')" id="btn-cat-${key}" class="cat-pill whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition bg-gray-100 text-gray-500 hover:bg-gray-200">
                            ${title}
                        </button>
                    `;

                    // Section
                    menuHtml += `
                        <div id="cat-section-${key}" class="scroll-mt-36 product-section">
                            <h3 class="font-extrabold text-xl text-slate-900 mb-4 capitalize">${title}</h3>
                            <div class="space-y-6">
                                ${items.map(item => renderFullCard(item)).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            catContainer.innerHTML = catHtml;
            menuContainer.innerHTML = menuHtml;

            // Highlight first cat
            if (cats.length > 0) setActiveCat(cats[0]);
        }


        function renderFullCard(item) {
            const jsonItem = JSON.stringify(item).replace(/'/g, "&#39;");
            return `
                <div class="flex gap-3 justify-between group item-card-dom" data-name="${item.name.toLowerCase()}" onclick='openDetail(${jsonItem})'>
                    <!-- Text Info -->
                    <div class="flex-1 flex flex-col justify-start">
                        <h4 class="font-bold text-slate-800 text-[15px] mb-1 leading-snug">${item.name}</h4>
                        <p class="text-xs text-gray-500 line-clamp-2 leading-normal mb-2 pr-2">${item.desc || 'Descripci贸n del platillo disponible para visualizaci贸n.'}</p>
                        <div class="mt-auto flex items-center gap-2">
                            <span class="font-bold text-slate-900 text-base">$${parseFloat(item.price).toFixed(2)}</span>
                            ${item.oldPrice ? `<span class="text-xs text-slate-400 line-through font-normal">$${item.oldPrice}</span>` : ''}
                        </div>
                    </div>

                    <!-- Image & Add Btn -->
                    <div class="relative w-32 h-28 shrink-0">
                         <img src="${item.image || 'https://placehold.co/150'}" class="w-full h-full object-cover rounded-xl bg-gray-100">
                         <!-- Add Button Absolute -->
                         <button class="absolute bottom-[-8px] right-[-8px] w-9 h-9 bg-white rounded-full shadow-md border border-gray-100 flex items-center justify-center text-orange-600 active:scale-90 transition">
                             <i class="fa-solid fa-plus text-sm font-bold"></i>
                         </button>
                    </div>
                </div>
                <hr class="border-gray-50/50 last:hidden">
             `;
        }

        // --- INTERACTION ---
        function scrollToCat(key) {
            const el = document.getElementById(`cat-section-${key}`);
            if (el) {
                // Offset calculation (header + sticky tabs) = approx 120px
                const y = el.getBoundingClientRect().top + window.scrollY - 120;
                window.scrollTo({ top: y, behavior: 'smooth' });
                setActiveCat(key);
            }
        }

        function setActiveCat(key) {
            // Reset all
            document.querySelectorAll('.cat-pill').forEach(b => {
                b.className = "cat-pill whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition bg-gray-100 text-gray-500 hover:bg-gray-200";
            });
            // Activate one
            const btn = document.getElementById(`btn-cat-${key}`);
            if (btn) {
                btn.className = "cat-pill whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold transition bg-orange-600 text-white shadow-md shadow-orange-500/30";
                // Scroll pill into view
                btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
            ACTIVE_CATEGORY = key;
        }

        function filterProducts(query) {
            const q = query.toLowerCase();
            document.querySelectorAll('.item-card-dom').forEach(el => {
                const name = el.getAttribute('data-name');
                if (name.includes(q)) {
                    el.style.display = 'flex';
                    // also show the hr
                    if (el.nextElementSibling && el.nextElementSibling.tagName === 'HR') el.nextElementSibling.style.display = 'block';
                } else {
                    el.style.display = 'none';
                    if (el.nextElementSibling && el.nextElementSibling.tagName === 'HR') el.nextElementSibling.style.display = 'none';
                }
            });
        }


        // --- MODALS & CART ---
        function openDetail(item) {
            CURRENT_ITEM = { ...item, qty: 1 };
            document.getElementById('detail-title').innerText = item.name;
            document.getElementById('detail-price').innerText = '$' + parseFloat(item.price).toFixed(2);
            document.getElementById('detail-desc').innerText = item.desc || "Sin descripci贸n";
            document.getElementById('detail-img').src = item.image || 'https://placehold.co/400';
            updateDetailTotal();
            document.getElementById('product-modal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('active');
        }

        function adjustDetailQty(delta) {
            const newQty = CURRENT_ITEM.qty + delta;
            if (newQty < 1) return;
            CURRENT_ITEM.qty = newQty;
            document.getElementById('detail-qty').innerText = newQty;
            updateDetailTotal();
        }

        function updateDetailTotal() {
            const total = (parseFloat(CURRENT_ITEM.price) * CURRENT_ITEM.qty).toFixed(2);
            document.getElementById('detail-btn-total').innerText = `$${total}`;
        }

        function addToCartFromDetail() {
            const total = parseFloat(CURRENT_ITEM.price) * CURRENT_ITEM.qty;
            const cartItem = {
                id: Date.now(),
                name: CURRENT_ITEM.name,
                price: parseFloat(CURRENT_ITEM.price),
                qty: CURRENT_ITEM.qty,
                total: total,
                image: CURRENT_ITEM.image
            };
            CART.push(cartItem);
            updateCartUI();
            closeProductModal();
        }

        function updateCartUI() {
            const count = CART.reduce((acc, i) => acc + i.qty, 0);
            const total = CART.reduce((acc, i) => acc + i.total, 0);
            const bar = document.getElementById('floating-cart');

            document.getElementById('cart-count').innerText = count;
            document.getElementById('cart-total').innerText = `$${total.toFixed(2)}`;

            // Show/Hide Bar
            if (count > 0) {
                bar.classList.remove('translate-y-32');
            } else {
                bar.classList.add('translate-y-32');
            }

            // Sync checkout
            document.getElementById('summ-products').innerText = `$${total.toFixed(2)}`;
            const shipping = 15;
            const service = 6;
            const tipVal = (total * (SELECTED_TIP / 100));
            document.getElementById('summ-shipping').innerText = `$${shipping.toFixed(2)}`;
            document.getElementById('summ-tip').innerText = `$${tipVal.toFixed(2)}`;

            const final = total + shipping + service + tipVal;
            document.getElementById('final-total').innerText = `$${final.toFixed(2)}`;
        }

        // --- CHECKOUT ---
        function openCheckout() {
            document.getElementById('checkout-modal').classList.add('active');

            const list = document.getElementById('checkout-items-list');
            list.innerHTML = CART.map(i => `
                <div class="flex gap-3">
                     <img src="${i.image || 'https://placehold.co/60'}" class="w-14 h-14 rounded-lg bg-gray-100 object-cover border border-gray-100">
                     <div class="flex-1">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-sm font-bold text-slate-800 line-clamp-2 leading-tight">${i.name}</span>
                            <span class="text-sm font-bold">$${i.total.toFixed(2)}</span>
                        </div>
                        <div class="flex items-center gap-3">
                             <div class="flex items-center border rounded px-1.5 py-0.5 text-xs font-bold text-slate-700 bg-gray-50 border-gray-200">
                                <span>x${i.qty}</span>
                             </div>
                             <button onclick="removeItem(${i.id})" class="text-xs text-gray-400 font-medium underline">Eliminar</button>
                        </div>
                     </div>
                </div>
            `).join('');

            document.getElementById('checkout-address').innerText = USER_ADDRESS;
            updateCartUI();
        }

        function closeCheckout() {
            document.getElementById('checkout-modal').classList.remove('active');
        }

        function removeItem(id) {
            CART = CART.filter(i => i.id !== id);
            openCheckout(); // Re-render list
            updateCartUI(); // Update totals and bar
            if (CART.length === 0) closeCheckout();
        }

        function setTip(pct) {
            SELECTED_TIP = pct;
            document.querySelectorAll('.tip-btn').forEach(btn => {
                // Reset
                btn.className = 'tip-btn flex-1 py-3 rounded-xl bg-gray-100 text-xs font-bold text-gray-500 border-2 border-transparent transition';
                // Activate
                if ((pct === 0 && btn.innerText === 'No') || btn.innerText.includes(pct + '%')) {
                    btn.className = 'tip-btn flex-1 py-3 rounded-xl bg-orange-50 text-xs font-bold text-orange-600 border-2 border-orange-500 transition';
                }
            });
            updateCartUI();
        }

        function openPaymentMethods() {
            document.getElementById('payment-modal').classList.add('active');
        }
        function closePaymentMethods() {
            document.getElementById('payment-modal').classList.remove('active');
        }
        function selectPayment(method) {
            SELECTED_PAYMENT = method;
            document.getElementById('checkout-payment-label').innerText = method;
            closePaymentMethods();
        }

        function submitOrder() {
            if (CART.length === 0) return;
            // logic
            const orderPayload = {
                slug: SHOP_DATA.slug,
                order: {
                    ref: 'APP-' + Math.floor(Math.random() * 10000),
                    customerPhone: USER_PHONE,
                    address: USER_ADDRESS,
                    paymentMethod: SELECTED_PAYMENT,
                    type: 'delivery',
                    items: CART,
                    total: document.getElementById('final-total').innerText,
                    status: 'pending'
                }
            };
            socket.emit('register-order', orderPayload);
        }

    </script>
</body>

</html>
